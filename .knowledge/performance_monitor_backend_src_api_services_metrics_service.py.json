{"is_source_file": true, "format": "Python", "description": "This file implements a metrics service for a MongoDB monitoring backend, providing functions to retrieve metrics data, generate summaries, and handle timeseries data from raw samples or rollup collections.", "external_files": ["src.api.schemas.metrics", "src.api.services.instances_service", "src.api.state"], "external_methods": ["list_active_instance_docs", "get_state", "PyMongoError"], "published": ["get_summary", "get_timeseries", "get_active_instances_for_sampling"], "classes": [], "methods": [{"name": "str _unit_for(metric: str)", "description": "Determines the unit string for a given metric name.", "scope": "", "scopeKind": ""}, {"name": "Tuple[datetime,datetime] _compute_range(req: TimeseriesRequest)", "description": "Calculates start and end datetimes for the timeseries request, defaulting to last hour if not specified.", "scope": "", "scopeKind": ""}, {"name": "_safe_get(d: dict, path: List[str], default=0)", "description": "Safely retrieves nested values from a dictionary given a list of keys, returning a default if any key is missing.", "scope": "", "scopeKind": ""}, {"name": "float _ops_sum(ops_per_sec: Dict[str, float])", "description": "Sums the operations per second values from a dictionary.", "scope": "", "scopeKind": ""}, {"name": "dict|None _get_latest_sample(request: Request, instance_id: str)", "description": "Retrieves the most recent metrics sample for a given instance.", "scope": "", "scopeKind": ""}, {"name": "List[dict] _get_recent_samples(request: Request, instance_id: str, limit: int = 20)", "description": "Retrieves recent metrics samples for an instance, limited to a configurable number.", "scope": "", "scopeKind": ""}, {"name": "dict|None _server_status_snapshot(request: Request, instance_id: str)", "description": "Fetches a server status snapshot from a MongoDB instance, used to fill in gaps in metrics data.", "scope": "", "scopeKind": ""}, {"name": "MetricsSummary get_summary(request: Request, instance_id: str)", "description": "Returns a metrics summary for a given instance, combining persisted samples and live server status if needed.", "scope": "", "scopeKind": ""}, {"name": "float _metric_from_sample(sample: dict, metric: str)", "description": "Extracts a specific metric's value from a metrics sample dataset.", "scope": "", "scopeKind": ""}, {"name": "bool _should_use_rollups(request: Request, start: datetime, end: datetime)", "description": "Decides whether to query metrics rollup data based on time span and configuration.", "scope": "", "scopeKind": ""}, {"name": "TimeseriesResponse _get_timeseries_from_rollups(request: Request, instance_id: str, req: TimeseriesRequest)", "description": "Retrieves timeseries data from rollup collections assuming pre-aggregated metrics.", "scope": "", "scopeKind": ""}, {"name": "TimeseriesResponse get_timeseries(request: Request, instance_id: str, req: TimeseriesRequest)", "description": "Provides timeseries data for a given instance and metric, deciding between raw samples and rollups depending on timeframe.", "scope": "", "scopeKind": ""}, {"name": "List[dict] get_active_instances_for_sampling(request: Request)", "description": "Returns active instances for background sampling.", "scope": "", "scopeKind": ""}], "calls": ["get_state(request.app).mongo.collections()", "list_active_instance_docs(request)", "logger.exception", "get_state(request.app).mongo.target_client"], "search-terms": ["metrics_service", "timeseries", "MongoDB performance", "serverStatus", "rollups", "active_instances"], "state": 2, "file_id": 11, "knowledge_revision": 87, "git_revision": "d74cfd9e45156ce797a4585d816d9a2c1367cabf", "revision_history": [{"33": "5c1110a3ebc62d3d78963eacede0143bf7676821"}, {"50": "ac108bb99020dc67cfe8a133c3fe05fd9ce788f5"}, {"87": "d74cfd9e45156ce797a4585d816d9a2c1367cabf"}], "ctags": [{"_type": "tag", "name": "_compute_range", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_service.py", "pattern": "/^def _compute_range(req: TimeseriesRequest) -> Tuple[datetime, datetime]:$/", "language": "Python", "typeref": "typename:Tuple[datetime,datetime]", "kind": "function", "signature": "(req: TimeseriesRequest)"}, {"_type": "tag", "name": "_get_latest_sample", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_service.py", "pattern": "/^def _get_latest_sample(request: Request, instance_id: str) -> dict | None:$/", "language": "Python", "typeref": "typename:dict|None", "kind": "function", "signature": "(request: Request, instance_id: str)"}, {"_type": "tag", "name": "_get_recent_samples", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_service.py", "pattern": "/^def _get_recent_samples(request: Request, instance_id: str, limit: int = 20) -> List[dict]:$/", "language": "Python", "typeref": "typename:List[dict]", "kind": "function", "signature": "(request: Request, instance_id: str, limit: int = 20)"}, {"_type": "tag", "name": "_get_timeseries_from_rollups", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_service.py", "pattern": "/^def _get_timeseries_from_rollups(request: Request, instance_id: str, req: TimeseriesRequest) -> /", "language": "Python", "typeref": "typename:TimeseriesResponse", "kind": "function", "signature": "(request: Request, instance_id: str, req: TimeseriesRequest)"}, {"_type": "tag", "name": "_metric_from_sample", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_service.py", "pattern": "/^def _metric_from_sample(sample: dict, metric: str) -> float:$/", "language": "Python", "typeref": "typename:float", "kind": "function", "signature": "(sample: dict, metric: str)"}, {"_type": "tag", "name": "_ops_sum", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_service.py", "pattern": "/^def _ops_sum(ops_per_sec: Dict[str, float]) -> float:$/", "language": "Python", "typeref": "typename:float", "kind": "function", "signature": "(ops_per_sec: Dict[str, float])"}, {"_type": "tag", "name": "_safe_get", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_service.py", "pattern": "/^def _safe_get(d: dict, path: List[str], default=0):$/", "language": "Python", "kind": "function", "signature": "(d: dict, path: List[str], default=0)"}, {"_type": "tag", "name": "_server_status_snapshot", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_service.py", "pattern": "/^def _server_status_snapshot(request: Request, instance_id: str) -> dict | None:$/", "language": "Python", "typeref": "typename:dict|None", "kind": "function", "signature": "(request: Request, instance_id: str)"}, {"_type": "tag", "name": "_should_use_rollups", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_service.py", "pattern": "/^def _should_use_rollups(request: Request, start: datetime, end: datetime) -> bool:$/", "language": "Python", "typeref": "typename:bool", "kind": "function", "signature": "(request: Request, start: datetime, end: datetime)"}, {"_type": "tag", "name": "_unit_for", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_service.py", "pattern": "/^def _unit_for(metric: str) -> str:$/", "language": "Python", "typeref": "typename:str", "kind": "function", "signature": "(metric: str)"}, {"_type": "tag", "name": "get_active_instances_for_sampling", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_service.py", "pattern": "/^def get_active_instances_for_sampling(request: Request) -> List[dict]:$/", "language": "Python", "typeref": "typename:List[dict]", "kind": "function", "signature": "(request: Request)"}, {"_type": "tag", "name": "get_summary", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_service.py", "pattern": "/^def get_summary(request: Request, instance_id: str) -> MetricsSummary:$/", "language": "Python", "typeref": "typename:MetricsSummary", "kind": "function", "signature": "(request: Request, instance_id: str)"}, {"_type": "tag", "name": "get_timeseries", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_service.py", "pattern": "/^def get_timeseries(request: Request, instance_id: str, req: TimeseriesRequest) -> TimeseriesResp/", "language": "Python", "typeref": "typename:TimeseriesResponse", "kind": "function", "signature": "(request: Request, instance_id: str, req: TimeseriesRequest)"}, {"_type": "tag", "name": "logger", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_service.py", "pattern": "/^logger = logging.getLogger(__name__)$/", "language": "Python", "kind": "variable"}], "hash": "e78c6552b6339de681cbf0bdacbfa971", "format-version": 4, "code-base-name": "performance_monitor_backend", "filename": "performance_monitor_backend/src/api/services/metrics_service.py", "fields": [{"name": "logger = logging.getLogger(__name__)", "scope": "", "scopeKind": "", "description": "unavailable"}]}