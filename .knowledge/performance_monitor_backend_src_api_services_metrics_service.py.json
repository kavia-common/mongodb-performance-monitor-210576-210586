{"is_source_file": true, "format": "Python", "description": "This file implements a metrics service in a FastAPI backend for monitoring MongoDB instances. It contains functions for retrieving, processing, and summarizing metrics data, including sampling, time-series generation, and server status snapshots. It interacts with MongoDB collections and external services, and defines multiple functions for internal computation and public APIs.", "external_files": ["src.api.schemas.metrics", "src.api.services.instances_service", "src.api.state", "pymongo.errors"], "external_methods": ["list_active_instance_docs", "get_state", "PyMongoError"], "published": ["get_summary", "get_timeseries", "get_active_instances_for_sampling"], "classes": [], "methods": [{"name": "str _unit_for(metric: str)", "description": "Determines the unit label for a given metric name.", "scope": "", "scopeKind": ""}, {"name": "Tuple[datetime,datetime] _compute_range(req: TimeseriesRequest)", "description": "Calculates the start and end datetime for a timeseries request based on the provided times or defaults.", "scope": "", "scopeKind": ""}, {"name": "_safe_get(d: dict, path: List[str], default=0)", "description": "Safely retrieves nested values from a dictionary with a default fallback.", "scope": "", "scopeKind": ""}, {"name": "float _ops_sum(ops_per_sec: Dict[str, float])", "description": "Sums the operations per second from a dictionary of counters.", "scope": "", "scopeKind": ""}, {"name": "dict|None _get_latest_sample(request: Request, instance_id: str)", "description": "Fetches the most recent sample document for a given instance.", "scope": "", "scopeKind": ""}, {"name": "List[dict] _get_recent_samples(request: Request, instance_id: str, limit: int = 20)", "description": "Retrieves a list of recent sample documents for an instance.", "scope": "", "scopeKind": ""}, {"name": "dict|None _server_status_snapshot(request: Request, instance_id: str)", "description": "Attempts to retrieve a serverStatus snapshot from the monitored instance for use when no samples exist.", "scope": "", "scopeKind": ""}, {"name": "MetricsSummary get_summary(request: Request, instance_id: str)", "description": "Provides a summarized view of metrics for a specific instance, combining persisted samples and live server status.", "scope": "", "scopeKind": ""}, {"name": "float _metric_from_sample(sample: dict, metric: str)", "description": "Extracts specific metric value from a sample document.", "scope": "", "scopeKind": ""}, {"name": "TimeseriesResponse get_timeseries(request: Request, instance_id: str, req: TimeseriesRequest)", "description": "Generates a time-series of metric data points from persisted samples, bucketed by averaging within intervals.", "scope": "", "scopeKind": ""}, {"name": "List[dict] get_active_instances_for_sampling(request: Request)", "description": "Retrieves active instances suitable for background metrics sampling.", "scope": "", "scopeKind": ""}], "calls": ["get_state", "list_active_instance_docs", "datetime.now", "datetime.now", "get_state", "get_state", "get_state", "get_state", "cols.metrics_samples.find_one", "cols.metrics_samples.find", "logger.exception", "cols.instances.find_one", "mongo.target_client", "client.admin.command", "cols.metrics_samples.find", "sum", "max"], "search-terms": ["metrics_service", "MongoDB performance", "Timeseries", "sample retrieval", "serverStatus", "metrics summary", "active instances", "bucketed timeseries"], "state": 2, "file_id": 11, "knowledge_revision": 50, "git_revision": "ac108bb99020dc67cfe8a133c3fe05fd9ce788f5", "revision_history": [{"33": "5c1110a3ebc62d3d78963eacede0143bf7676821"}, {"50": "ac108bb99020dc67cfe8a133c3fe05fd9ce788f5"}], "ctags": [{"_type": "tag", "name": "_compute_range", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_service.py", "pattern": "/^def _compute_range(req: TimeseriesRequest) -> Tuple[datetime, datetime]:$/", "language": "Python", "typeref": "typename:Tuple[datetime,datetime]", "kind": "function", "signature": "(req: TimeseriesRequest)"}, {"_type": "tag", "name": "_get_latest_sample", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_service.py", "pattern": "/^def _get_latest_sample(request: Request, instance_id: str) -> dict | None:$/", "language": "Python", "typeref": "typename:dict|None", "kind": "function", "signature": "(request: Request, instance_id: str)"}, {"_type": "tag", "name": "_get_recent_samples", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_service.py", "pattern": "/^def _get_recent_samples(request: Request, instance_id: str, limit: int = 20) -> List[dict]:$/", "language": "Python", "typeref": "typename:List[dict]", "kind": "function", "signature": "(request: Request, instance_id: str, limit: int = 20)"}, {"_type": "tag", "name": "_metric_from_sample", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_service.py", "pattern": "/^def _metric_from_sample(sample: dict, metric: str) -> float:$/", "language": "Python", "typeref": "typename:float", "kind": "function", "signature": "(sample: dict, metric: str)"}, {"_type": "tag", "name": "_ops_sum", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_service.py", "pattern": "/^def _ops_sum(ops_per_sec: Dict[str, float]) -> float:$/", "language": "Python", "typeref": "typename:float", "kind": "function", "signature": "(ops_per_sec: Dict[str, float])"}, {"_type": "tag", "name": "_safe_get", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_service.py", "pattern": "/^def _safe_get(d: dict, path: List[str], default=0):$/", "language": "Python", "kind": "function", "signature": "(d: dict, path: List[str], default=0)"}, {"_type": "tag", "name": "_server_status_snapshot", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_service.py", "pattern": "/^def _server_status_snapshot(request: Request, instance_id: str) -> dict | None:$/", "language": "Python", "typeref": "typename:dict|None", "kind": "function", "signature": "(request: Request, instance_id: str)"}, {"_type": "tag", "name": "_unit_for", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_service.py", "pattern": "/^def _unit_for(metric: str) -> str:$/", "language": "Python", "typeref": "typename:str", "kind": "function", "signature": "(metric: str)"}, {"_type": "tag", "name": "get_active_instances_for_sampling", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_service.py", "pattern": "/^def get_active_instances_for_sampling(request: Request) -> List[dict]:$/", "language": "Python", "typeref": "typename:List[dict]", "kind": "function", "signature": "(request: Request)"}, {"_type": "tag", "name": "get_summary", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_service.py", "pattern": "/^def get_summary(request: Request, instance_id: str) -> MetricsSummary:$/", "language": "Python", "typeref": "typename:MetricsSummary", "kind": "function", "signature": "(request: Request, instance_id: str)"}, {"_type": "tag", "name": "get_timeseries", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_service.py", "pattern": "/^def get_timeseries(request: Request, instance_id: str, req: TimeseriesRequest) -> TimeseriesResp/", "language": "Python", "typeref": "typename:TimeseriesResponse", "kind": "function", "signature": "(request: Request, instance_id: str, req: TimeseriesRequest)"}, {"_type": "tag", "name": "logger", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_service.py", "pattern": "/^logger = logging.getLogger(__name__)$/", "language": "Python", "kind": "variable"}], "hash": "035b8352416bfa02977b079ef14970b7", "format-version": 4, "code-base-name": "performance_monitor_backend", "filename": "performance_monitor_backend/src/api/services/metrics_service.py", "fields": [{"name": "logger = logging.getLogger(__name__)", "scope": "", "scopeKind": "", "description": "unavailable"}]}