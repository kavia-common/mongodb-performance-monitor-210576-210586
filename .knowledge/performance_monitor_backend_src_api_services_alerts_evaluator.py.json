{"is_source_file": true, "format": "Python", "description": "This file implements an asynchronous alert evaluation system for monitoring MongoDB performance. It fetches recent metrics samples, applies alert rules, and generates events when certain thresholds are crossed, with mechanisms to prevent flapping through cooldown periods. The core functions include rule evaluation, event creation, and a background loop to periodically perform these tasks.", "external_files": ["src.api.schemas.common", "src.api.state"], "external_methods": ["src.api.schemas.common.utc_now", "src.api.state.AppState"], "published": ["alerts_evaluator_loop"], "classes": [], "methods": [{"name": "_run_in_thread(func, *args, **kwargs)", "description": "Runs a blocking function in an executor thread to prevent blocking the asyncio event loop.", "scope": "", "scopeKind": ""}, {"name": "float _safe_float(v: Any, default: float = 0.0)", "description": "Safely converts a value to float, with a default fallback.", "scope": "", "scopeKind": ""}, {"name": "float _ops_sum(ops_per_sec: Dict[str, float])", "description": "Sums operation counts from a dictionary of operation metrics.", "scope": "", "scopeKind": ""}, {"name": "List[str] _select_instances_for_rule(inst_docs: List[dict], rule: dict)", "description": "Determines the list of instance IDs applicable for a given rule, based on the rule's scope or all active instances.", "scope": "", "scopeKind": ""}, {"name": "List[dict] _get_active_instance_docs(state: AppState)", "description": "Fetches documents of all active or enabled instances from MongoDB.", "scope": "", "scopeKind": ""}, {"name": "List[dict] _load_enabled_rules(state: AppState)", "description": "Fetches all enabled alert rules for evaluation.", "scope": "", "scopeKind": ""}, {"name": "List[dict] _fetch_samples_in_window( state: AppState, instance_id: str, window_start: datetime, window_end: datetime, )", "description": "Retrieves metric samples within a specific time window for an instance.", "scope": "", "scopeKind": ""}, {"name": "Tuple[Optional[float],str] _compute_signal(rule: dict, samples: List[dict])", "description": "Calculates a signal value and label for a rule based on recent samples.", "scope": "", "scopeKind": ""}, {"name": "Optional[bool] _should_trigger(value: Optional[float], threshold: float)", "description": "Determines whether a signal value exceeds its threshold, indicating an alert condition.", "scope": "", "scopeKind": ""}, {"name": "Optional[dict] _latest_event_for_pair(state: AppState, instance_id: str, rule_id: str)", "description": "Retrieves the most recent alert event for a given instance and rule.", "scope": "", "scopeKind": ""}, {"name": "bool _within_cooldown(now: datetime, last_event: dict, cooldown_sec: int)", "description": "Checks if the last event is within the cooldown period to prevent flapping.", "scope": "", "scopeKind": ""}, {"name": "None _insert_event(state: AppState, doc: dict)", "description": "Inserts a new alert event into MongoDB.", "scope": "", "scopeKind": ""}, {"name": "str _event_title(rule: dict, instance_id: str, is_trigger: bool)", "description": "Generates a title string for an alert event, indicating trigger/resolution.", "scope": "", "scopeKind": ""}, {"name": "str _event_message(rule: dict, instance_id: str, is_trigger: bool, value: Optional[float], label: str)", "description": "Creates a message body for an alert event, describing the rule condition and values.", "scope": "", "scopeKind": ""}, {"name": "None _evaluate_one_rule_instance( state: AppState, rule: dict, rule_id: str, instance_id: str, now: datetime, cooldown_sec: int, )", "description": "Evaluates a specific rule for a specific instance, generating trigger/resolution events as needed.", "scope": "", "scopeKind": ""}, {"name": "None _evaluation_tick(state: AppState)", "description": "Performs a single evaluation cycle for all rules and instances.", "scope": "", "scopeKind": ""}, {"name": "None alerts_evaluator_loop(state: AppState, shutdown_event: asyncio.Event)", "description": "Main background loop that periodically runs the alert evaluation process, breaking on a shutdown event.", "scope": "", "scopeKind": ""}], "calls": ["asyncio.to_thread", "list", "dict.get", "sum", "max", "await _run_in_thread", "await _fetch_samples_in_window", "await _latest_event_for_pair", "await _insert_event", "asyncio.wait_for", "datetime.now", "timezone.utc", "logger.info", "logger.exception"], "search-terms": ["alerts evaluation", "MongoDB metric samples", "alert rules", "triggered events", "flapping prevention", "async background loop", "MongoDB alert_events", "rule threshold evaluation"], "state": 2, "file_id": 28, "knowledge_revision": 77, "git_revision": "9e7446029497066b1021343648c0face5bcaa592", "ctags": [{"_type": "tag", "name": "_compute_signal", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/alerts_evaluator.py", "pattern": "/^def _compute_signal(rule: dict, samples: List[dict]) -> Tuple[Optional[float], str]:$/", "language": "Python", "typeref": "typename:Tuple[Optional[float],str]", "kind": "function", "signature": "(rule: dict, samples: List[dict])"}, {"_type": "tag", "name": "_evaluate_one_rule_instance", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/alerts_evaluator.py", "pattern": "/^async def _evaluate_one_rule_instance($/", "language": "Python", "typeref": "typename:None", "kind": "function", "signature": "( state: AppState, rule: dict, rule_id: str, instance_id: str, now: datetime, cooldown_sec: int, )"}, {"_type": "tag", "name": "_evaluation_tick", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/alerts_evaluator.py", "pattern": "/^async def _evaluation_tick(state: AppState) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "function", "signature": "(state: AppState)"}, {"_type": "tag", "name": "_event_message", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/alerts_evaluator.py", "pattern": "/^def _event_message(rule: dict, instance_id: str, is_trigger: bool, value: Optional[float], label/", "language": "Python", "typeref": "typename:str", "kind": "function", "signature": "(rule: dict, instance_id: str, is_trigger: bool, value: Optional[float], label: str)"}, {"_type": "tag", "name": "_event_title", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/alerts_evaluator.py", "pattern": "/^def _event_title(rule: dict, instance_id: str, is_trigger: bool) -> str:$/", "language": "Python", "typeref": "typename:str", "kind": "function", "signature": "(rule: dict, instance_id: str, is_trigger: bool)"}, {"_type": "tag", "name": "_fetch_samples_in_window", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/alerts_evaluator.py", "pattern": "/^async def _fetch_samples_in_window($/", "language": "Python", "typeref": "typename:List[dict]", "kind": "function", "signature": "( state: AppState, instance_id: str, window_start: datetime, window_end: datetime, )"}, {"_type": "tag", "name": "_get_active_instance_docs", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/alerts_evaluator.py", "pattern": "/^async def _get_active_instance_docs(state: AppState) -> List[dict]:$/", "language": "Python", "typeref": "typename:List[dict]", "kind": "function", "signature": "(state: AppState)"}, {"_type": "tag", "name": "_insert_event", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/alerts_evaluator.py", "pattern": "/^async def _insert_event(state: AppState, doc: dict) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "function", "signature": "(state: AppState, doc: dict)"}, {"_type": "tag", "name": "_latest_event_for_pair", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/alerts_evaluator.py", "pattern": "/^async def _latest_event_for_pair(state: AppState, instance_id: str, rule_id: str) -> Optional[di/", "language": "Python", "typeref": "typename:Optional[dict]", "kind": "function", "signature": "(state: AppState, instance_id: str, rule_id: str)"}, {"_type": "tag", "name": "_load_enabled_rules", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/alerts_evaluator.py", "pattern": "/^async def _load_enabled_rules(state: AppState) -> List[dict]:$/", "language": "Python", "typeref": "typename:List[dict]", "kind": "function", "signature": "(state: AppState)"}, {"_type": "tag", "name": "_ops_sum", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/alerts_evaluator.py", "pattern": "/^def _ops_sum(ops_per_sec: Dict[str, float]) -> float:$/", "language": "Python", "typeref": "typename:float", "kind": "function", "signature": "(ops_per_sec: Dict[str, float])"}, {"_type": "tag", "name": "_run_in_thread", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/alerts_evaluator.py", "pattern": "/^async def _run_in_thread(func, *args, **kwargs):$/", "language": "Python", "kind": "function", "signature": "(func, *args, **kwargs)"}, {"_type": "tag", "name": "_safe_float", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/alerts_evaluator.py", "pattern": "/^def _safe_float(v: Any, default: float = 0.0) -> float:$/", "language": "Python", "typeref": "typename:float", "kind": "function", "signature": "(v: Any, default: float = 0.0)"}, {"_type": "tag", "name": "_select_instances_for_rule", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/alerts_evaluator.py", "pattern": "/^def _select_instances_for_rule(inst_docs: List[dict], rule: dict) -> List[str]:$/", "language": "Python", "typeref": "typename:List[str]", "kind": "function", "signature": "(inst_docs: List[dict], rule: dict)"}, {"_type": "tag", "name": "_should_trigger", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/alerts_evaluator.py", "pattern": "/^def _should_trigger(value: Optional[float], threshold: float) -> Optional[bool]:$/", "language": "Python", "typeref": "typename:Optional[bool]", "kind": "function", "signature": "(value: Optional[float], threshold: float)"}, {"_type": "tag", "name": "_within_cooldown", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/alerts_evaluator.py", "pattern": "/^def _within_cooldown(now: datetime, last_event: dict, cooldown_sec: int) -> bool:$/", "language": "Python", "typeref": "typename:bool", "kind": "function", "signature": "(now: datetime, last_event: dict, cooldown_sec: int)"}, {"_type": "tag", "name": "alerts_evaluator_loop", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/alerts_evaluator.py", "pattern": "/^async def alerts_evaluator_loop(state: AppState, shutdown_event: asyncio.Event) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "function", "signature": "(state: AppState, shutdown_event: asyncio.Event)"}, {"_type": "tag", "name": "logger", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/alerts_evaluator.py", "pattern": "/^logger = logging.getLogger(__name__)$/", "language": "Python", "kind": "variable"}], "hash": "485c7746e43554c2e47d5a7f1afa467e", "format-version": 4, "code-base-name": "performance_monitor_backend", "filename": "performance_monitor_backend/src/api/services/alerts_evaluator.py", "fields": [{"name": "logger = logging.getLogger(__name__)", "scope": "", "scopeKind": "", "description": "unavailable"}], "revision_history": [{"77": "9e7446029497066b1021343648c0face5bcaa592"}]}