{"is_source_file": true, "format": "Python", "description": "This file contains asynchronous functions and internal helpers for sampling MongoDB server metrics, managing retention of sample data, and orchestrating periodic background sampling tasks. It interacts with MongoDB via a client, processes server status info, computes differences in operation rates, and integrates with application state and configuration.", "external_files": ["src.api.schemas.common", "src.api.state", "pymongo.errors"], "external_methods": ["src.api.schemas.common.utc_now", "src.api.state.AppState", "pymongo.errors.PyMongoError"], "published": ["sampler_loop"], "classes": [], "methods": [{"name": "Dict[str,Any] _extract_server_status_fields(server_status: Dict[str, Any])", "description": "Extracts specific status fields from the server status dictionary, including current connections, opcounters, and resident memory in MB.", "scope": "", "scopeKind": ""}, {"name": "Dict[str,float] _diff_ops_per_sec(prev: Optional[dict], cur: dict, interval_sec: int)", "description": "Calculates per-second operation rates between previous and current server status data over a specified interval.", "scope": "", "scopeKind": ""}, {"name": "_run_in_thread(func, *args, **kwargs)", "description": "Runs a blocking function in an asyncio thread pool and awaits its completion.", "scope": "", "scopeKind": ""}, {"name": "Optional[Dict[str,Any]] _fetch_server_status(mongo_client, instance_id: str)", "description": "Fetches the server status document asynchronously, handling exceptions and logging errors.", "scope": "", "scopeKind": ""}, {"name": "None _upsert_sample(state: AppState, sample_doc: dict)", "description": "Inserts a metrics sample document into the MongoDB collection asynchronously.", "scope": "", "scopeKind": ""}, {"name": "None _apply_retention(state: AppState)", "description": "Deletes old metrics samples based on retention policy, handling exceptions.", "scope": "", "scopeKind": ""}, {"name": "None sampler_loop(state: AppState, shutdown_event: asyncio.Event)", "description": "Main asynchronous background loop that periodically samples metrics from active MongoDB instances, processes data, stores samples, and enforces data retention.", "scope": "", "scopeKind": ""}, {"name": "float rate(k: str)", "scope": "_diff_ops_per_sec", "scopeKind": "function", "description": "unavailable"}], "calls": ["asyncio.to_thread", "pymongo.admin.Database.command", "cols.metrics_samples.insert_one", "cols.metrics_samples.delete_many", "cols.instances.find", "state.mongo.target_client", "utc_now", "asyncio.wait_for", "datetime.now"], "search-terms": ["MongoDB metrics sampling", "asyncio background loop", "serverStatus collection", "metrics retention", "instanceId", "opsPerSec calculation", "metrics_samples collection", "active instances", "target_client"], "state": 2, "file_id": 24, "knowledge_revision": 57, "git_revision": "ac108bb99020dc67cfe8a133c3fe05fd9ce788f5", "ctags": [{"_type": "tag", "name": "_apply_retention", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_sampler.py", "pattern": "/^async def _apply_retention(state: AppState) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "function", "signature": "(state: AppState)"}, {"_type": "tag", "name": "_diff_ops_per_sec", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_sampler.py", "pattern": "/^def _diff_ops_per_sec(prev: Optional[dict], cur: dict, interval_sec: int) -> Dict[str, float]:$/", "language": "Python", "typeref": "typename:Dict[str,float]", "kind": "function", "signature": "(prev: Optional[dict], cur: dict, interval_sec: int)"}, {"_type": "tag", "name": "_extract_server_status_fields", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_sampler.py", "pattern": "/^def _extract_server_status_fields(server_status: Dict[str, Any]) -> Dict[str, Any]:$/", "language": "Python", "typeref": "typename:Dict[str,Any]", "kind": "function", "signature": "(server_status: Dict[str, Any])"}, {"_type": "tag", "name": "_fetch_server_status", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_sampler.py", "pattern": "/^async def _fetch_server_status(mongo_client, instance_id: str) -> Optional[Dict[str, Any]]:$/", "language": "Python", "typeref": "typename:Optional[Dict[str,Any]]", "kind": "function", "signature": "(mongo_client, instance_id: str)"}, {"_type": "tag", "name": "_run_in_thread", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_sampler.py", "pattern": "/^async def _run_in_thread(func, *args, **kwargs):$/", "language": "Python", "kind": "function", "signature": "(func, *args, **kwargs)"}, {"_type": "tag", "name": "_upsert_sample", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_sampler.py", "pattern": "/^async def _upsert_sample(state: AppState, sample_doc: dict) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "function", "signature": "(state: AppState, sample_doc: dict)"}, {"_type": "tag", "name": "logger", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_sampler.py", "pattern": "/^logger = logging.getLogger(__name__)$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "rate", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_sampler.py", "pattern": "/^    def rate(k: str) -> float:$/", "file": true, "language": "Python", "typeref": "typename:float", "kind": "function", "signature": "(k: str)", "scope": "_diff_ops_per_sec", "scopeKind": "function"}, {"_type": "tag", "name": "sampler_loop", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_sampler.py", "pattern": "/^async def sampler_loop(state: AppState, shutdown_event: asyncio.Event) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "function", "signature": "(state: AppState, shutdown_event: asyncio.Event)"}], "hash": "749a12d474cc91227418ecf61357d0fb", "format-version": 4, "code-base-name": "performance_monitor_backend", "filename": "performance_monitor_backend/src/api/services/metrics_sampler.py", "fields": [{"name": "logger = logging.getLogger(__name__)", "scope": "", "scopeKind": "", "description": "unavailable"}], "revision_history": [{"57": "ac108bb99020dc67cfe8a133c3fe05fd9ce788f5"}]}