{"is_source_file": true, "format": "Python", "description": "This source file implements asynchronous functions and helpers for rolling up metrics data in a MongoDB-backed system. It includes logic for bucketing timestamped samples, aggregating metrics, fetching active instances, and running a background loop for periodic rollup tasks.", "external_files": ["src.api.schemas.common", "src.api.state"], "external_methods": ["asyncio.to_thread", "asyncio.wait_for", "logging.getLogger", "datetime.utcnow", "datetime.now", "datetime.fromtimestamp", "datetime.timedelta", "timezone.utc"], "published": ["rollup_loop"], "classes": [], "methods": [{"name": "_run_in_thread(func, *args, **kwargs)", "description": "Runs a blocking function in a separate thread and returns the result asynchronously.", "scope": "", "scopeKind": ""}, {"name": "datetime _floor_to_bucket(ts: datetime, bucket_seconds: int)", "description": "Converts a timestamp to the start of its corresponding bucket based on bucket size in seconds.", "scope": "", "scopeKind": ""}, {"name": "float _safe_float(v: Any, default: float = 0.0)", "description": "Safely converts a value to float, returning a default if conversion fails.", "scope": "", "scopeKind": ""}, {"name": "float _ops_sum(ops_per_sec: Dict[str, float])", "description": "Calculates the sum of 'operations per second' from a dict of metrics.", "scope": "", "scopeKind": ""}, {"name": "List[dict] _build_rollup_docs(instance_id: str, bucket: datetime, samples: List[dict])", "description": "Creates rollup documents for given samples and metadata, aggregating metrics.", "scope": "", "scopeKind": ""}, {"name": "List[str] _fetch_active_instance_ids(state: AppState)", "description": "Fetches IDs of active instances from MongoDB.", "scope": "", "scopeKind": ""}, {"name": "Optional[datetime] _last_rollup_bucket(state: AppState, instance_id: str)", "description": "Retrieves the timestamp of the last completed rollup for a given instance.", "scope": "", "scopeKind": ""}, {"name": "int _rollup_instance_range( state: AppState, instance_id: str, start_bucket: datetime, end_exclusive: datetime, bucket_seconds: int, )", "description": "Processes raw samples for an instance over a range of buckets and creates rollup entries.", "scope": "", "scopeKind": ""}, {"name": "None _rollup_tick(state: AppState)", "description": "Performs a single tick of the rollup process, covering all active instances.", "scope": "", "scopeKind": ""}, {"name": "None rollup_loop(state: AppState, shutdown_event: asyncio.Event)", "description": "Background asynchronous loop running periodic metrics rollup, controlled via configuration.", "scope": "", "scopeKind": ""}, {"name": "dict mk(metric: str, vals: List[float])", "scope": "_build_rollup_docs", "scopeKind": "function", "description": "unavailable"}], "calls": ["asyncio.to_thread", "asyncio.wait_for", "logging.getLogger", "datetime.utcnow", "datetime.now", "datetime.fromtimestamp", "datetime.timedelta", "utc_now", "max", "min", "list", "dict", "str", "int", "float", "append", "update_one", "find", "find_one", "sort", "projection"], "search-terms": ["metrics rollup", "MongoDB metrics sampling", "asyncio metrics background task", "bucketed time aggregation", "MongoDB collection metrics_samples", "metrics aggregation functions", "instanceId rollup", "background metrics processing"], "state": 2, "file_id": 29, "knowledge_revision": 89, "git_revision": "d74cfd9e45156ce797a4585d816d9a2c1367cabf", "ctags": [{"_type": "tag", "name": "_build_rollup_docs", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_rollup.py", "pattern": "/^def _build_rollup_docs(instance_id: str, bucket: datetime, samples: List[dict]) -> List[dict]:$/", "language": "Python", "typeref": "typename:List[dict]", "kind": "function", "signature": "(instance_id: str, bucket: datetime, samples: List[dict])"}, {"_type": "tag", "name": "_fetch_active_instance_ids", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_rollup.py", "pattern": "/^async def _fetch_active_instance_ids(state: AppState) -> List[str]:$/", "language": "Python", "typeref": "typename:List[str]", "kind": "function", "signature": "(state: AppState)"}, {"_type": "tag", "name": "_floor_to_bucket", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_rollup.py", "pattern": "/^def _floor_to_bucket(ts: datetime, bucket_seconds: int) -> datetime:$/", "language": "Python", "typeref": "typename:datetime", "kind": "function", "signature": "(ts: datetime, bucket_seconds: int)"}, {"_type": "tag", "name": "_last_rollup_bucket", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_rollup.py", "pattern": "/^async def _last_rollup_bucket(state: AppState, instance_id: str) -> Optional[datetime]:$/", "language": "Python", "typeref": "typename:Optional[datetime]", "kind": "function", "signature": "(state: AppState, instance_id: str)"}, {"_type": "tag", "name": "_ops_sum", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_rollup.py", "pattern": "/^def _ops_sum(ops_per_sec: Dict[str, float]) -> float:$/", "language": "Python", "typeref": "typename:float", "kind": "function", "signature": "(ops_per_sec: Dict[str, float])"}, {"_type": "tag", "name": "_rollup_instance_range", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_rollup.py", "pattern": "/^async def _rollup_instance_range($/", "language": "Python", "typeref": "typename:int", "kind": "function", "signature": "( state: AppState, instance_id: str, start_bucket: datetime, end_exclusive: datetime, bucket_seconds: int, )"}, {"_type": "tag", "name": "_rollup_tick", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_rollup.py", "pattern": "/^async def _rollup_tick(state: AppState) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "function", "signature": "(state: AppState)"}, {"_type": "tag", "name": "_run_in_thread", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_rollup.py", "pattern": "/^async def _run_in_thread(func, *args, **kwargs):$/", "language": "Python", "kind": "function", "signature": "(func, *args, **kwargs)"}, {"_type": "tag", "name": "_safe_float", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_rollup.py", "pattern": "/^def _safe_float(v: Any, default: float = 0.0) -> float:$/", "language": "Python", "typeref": "typename:float", "kind": "function", "signature": "(v: Any, default: float = 0.0)"}, {"_type": "tag", "name": "logger", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_rollup.py", "pattern": "/^logger = logging.getLogger(__name__)$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "mk", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_rollup.py", "pattern": "/^    def mk(metric: str, vals: List[float]) -> dict:$/", "file": true, "language": "Python", "typeref": "typename:dict", "kind": "function", "signature": "(metric: str, vals: List[float])", "scope": "_build_rollup_docs", "scopeKind": "function"}, {"_type": "tag", "name": "rollup_loop", "path": "/home/kavia/workspace/code-generation/mongodb-performance-monitor-210576-210586/performance_monitor_backend/src/api/services/metrics_rollup.py", "pattern": "/^async def rollup_loop(state: AppState, shutdown_event: asyncio.Event) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "function", "signature": "(state: AppState, shutdown_event: asyncio.Event)"}], "hash": "8f26ca542f4a4cd489990b9a8d44cb2b", "format-version": 4, "code-base-name": "performance_monitor_backend", "filename": "performance_monitor_backend/src/api/services/metrics_rollup.py", "fields": [{"name": "logger = logging.getLogger(__name__)", "scope": "", "scopeKind": "", "description": "unavailable"}], "revision_history": [{"89": "d74cfd9e45156ce797a4585d816d9a2c1367cabf"}]}